# 分区表

## 按月分区

 ```sql
 CREATE TABLE `blade_log_usual` (
  `uid` varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '主键',
  `site` varchar(40) DEFAULT NULL COMMENT '租户ID',
  `belong_to` varchar(80) DEFAULT NULL COMMENT '所说ID',
  `create_user_id` varchar(40) DEFAULT NULL COMMENT '创建人',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `update_user_id` varchar(40) DEFAULT NULL COMMENT '修改人',
  `update_time` bigint DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`uid`,`create_time`)
) COMMENT='foo测试表';


drop table blade_log_usual;

-- 删除原来的主键
ALTER TABLE blade_log_usual DROP PRIMARY KEY;
ALTER TABLE blade_log_api DROP PRIMARY KEY;
ALTER TABLE blade_log_error DROP PRIMARY KEY;
 
-- 添加新的主键
ALTER TABLE blade_log_usual ADD PRIMARY KEY (uid, create_time);
ALTER TABLE blade_log_api ADD PRIMARY KEY (uid, create_time);
ALTER TABLE blade_log_error ADD PRIMARY KEY (uid, create_time);

-- 创建初始数据分区
ALTER TABLE blade_log_usual
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202412 VALUES LESS THAN (TO_DAYS('2024-12-01'))
);
ALTER TABLE blade_log_api
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202412 VALUES LESS THAN (TO_DAYS('2024-12-01'))
);
ALTER TABLE blade_log_error
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202412 VALUES LESS THAN (TO_DAYS('2024-12-01'))
);


drop procedure create_ten_year_tables;

DELIMITER //
CREATE PROCEDURE create_ten_year_tables
(
 IN table_name VARCHAR(255),
 IN table_schema VARCHAR(255)
)
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE par_exist INT;
    DECLARE next_month VARCHAR(20);
    DECLARE next_month_first_day DATE;

    WHILE i <= 120 DO
   set par_exist = null;
     SET next_month = CONCAT('p', DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL i MONTH), '%Y%m'));
     SET next_month_first_day = LAST_DAY(DATE_ADD(CURDATE(), INTERVAL i MONTH)) + INTERVAL 1 DAY;
   
   set @sql2 = CONCAT('SELECT COUNT(1) INTO @temp_count 
        FROM information_schema.PARTITIONS WHERE TABLE_NAME = ''', table_name, ''' and TABLE_SCHEMA = ''',table_schema,''' and PARTITION_NAME=''',next_month,''';');
    
    select @sql2;
    PREPARE stmt2 FROM @sql2;
	EXECUTE stmt2;
	DEALLOCATE PREPARE stmt2;
     
     SET par_exist = @temp_count; 
     IF par_exist = 0 THEN
         SET @sql = CONCAT('ALTER TABLE ', table_schema, '.', table_name, ' ADD PARTITION (PARTITION ', next_month, ' VALUES LESS THAN (TO_DAYS(\'', next_month_first_day, '\')))');
         PREPARE stmt FROM @sql;
         EXECUTE stmt;
         DEALLOCATE PREPARE stmt;
  	ELSE
   		SELECT CONCAT(par_exist, table_name, ' 已找到下月日志分区，跳过创建');
     END IF;
        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;

-- 创建计划任务，在每月最后一天执行存储过程创建分区
-- CREATE EVENT IF NOT EXISTS monthly_partition_event
-- ON SCHEDULE EVERY 1 MONTH
-- STARTS CONCAT(DATE_FORMAT(LAST_DAY(CURRENT_DATE), '%Y-%m-'), DAY(LAST_DAY(CURRENT_DATE)), ' 23:00:00')
-- DO
-- BEGIN
-- 	CALL create_monthly_partition('blade_log_usual', 'cms_dev');
-- 	CALL create_monthly_partition('blade_log_api', 'cms_dev');
-- 	CALL create_monthly_partition('blade_log_error', 'cms_dev');
-- END;

SET @table_schema = 'cms_dev';
SET @table_name1 = 'blade_log_usual';
SET @table_name2 = 'blade_log_api';
SET @table_name3 = 'blade_log_error'; 
CALL create_ten_year_tables(@table_name1, table_schema);
CALL create_ten_year_tables(@table_name2, table_schema);
CALL create_ten_year_tables(@table_name3, table_schema);


-- 创建最大的分区
ALTER TABLE blade_log_usual
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p209912 VALUES LESS THAN (MAXVALUE)
);
ALTER TABLE blade_log_api
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p209912 VALUES LESS THAN (MAXVALUE)
);
ALTER TABLE blade_log_error
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p209912 VALUES LESS THAN (MAXVALUE)
);
ALTER TABLE blade_log_sap
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p209912 VALUES LESS THAN (MAXVALUE)
);

SELECT count(1)
        FROM information_schema.PARTITIONS 
        WHERE TABLE_SCHEMA = 'test' 
          AND PARTITION_NAME is not null;

 ```