# Spring AI 核心概念学习笔记

本文档总结了 Spring AI 中的核心概念，帮助理解其实现原理。

## 模型 (Models)

AI 模型是处理和生成信息的算法，模仿人类认知功能。通过学习大量数据集中的模式，模型可以进行预测、生成文本、图像等。

Spring AI 支持处理语言、图像和音频的模型。其中，将文本作为输入并输出数字的模型通常称为嵌入 (embedding)，用于更高级的用例。

GPT 等模型的预训练特性使其成为通用的开发工具，无需深入的机器学习背景。

## 提示 (Prompts)

提示是指导 AI 模型产生特定输出的语言输入。在许多 AI 模型中，提示不仅仅是简单的字符串，可能包含具有不同角色的多个文本输入（例如系统角色和用户角色）。

创建有效的提示是一门艺术和科学，被称为“提示工程”。有效的提示可以显著改善输出结果。

### 提示模板 (Prompt Templates)

提示模板用于创建和管理提示，通过模板引擎（Spring AI 使用 StringTemplate）将用户输入的值填充到模板中。

例如：`告诉我一个 {adjective} 的关于 {content} 的笑话。`

提示模板类似于 Spring MVC 中的“视图”，使用模型对象（通常是 `java.util.Map`）填充占位符。

## 嵌入 (Embeddings)

嵌入是文本、图像或视频的数值表示，用于捕获输入之间的关系。

嵌入将文本、图像和视频转换为浮点数数组（向量），这些向量旨在捕获其含义。通过计算两个文本的向量表示之间的数值距离，可以确定它们之间的相似性。

在实际应用中，嵌入与检索增强生成 (RAG) 模式特别相关。它们将数据表示为语义空间中的点，点之间的距离反映了含义的相似性。

## 令牌 (Tokens)

令牌是 AI 模型工作的基本单位。输入时，模型将单词转换为令牌；输出时，将令牌转换回单词。

在英语中，一个令牌大约对应一个单词的 75%。令牌数量通常决定了托管 AI 模型的费用。

模型有令牌限制，即“上下文窗口”，超出此限制的文本将不会被处理。处理超出限制的数据需要分块等软件工程策略。Spring AI 项目提供了帮助处理此任务的功能。

## 结构化输出 (Structured Output)

AI 模型的输出通常是 `java.lang.String` 类型，即使要求输出 JSON 格式。这需要将结果字符串转换为可用的数据结构。

结构化输出转换通过精心设计的提示实现，可能需要多次与模型交互以获得期望的格式。

## 将数据和 API 引入 AI 模型 (Bringing Your Data & APIs to the AI Model)

有三种技术可以将 AI 模型未训练过的信息引入模型：

- **微调 (Fine Tuning)**: 传统的机器学习技术，调整模型内部权重，对于大型模型资源密集且困难。
- **提示填充 (Prompt Stuffing)**: 将数据嵌入到提供给模型的提示中。需要技术在模型的上下文窗口限制内呈现相关数据，也称为检索增强生成 (RAG)。
- **工具调用 (Tool Calling)**: 允许注册用户定义的服务作为工具，连接大型语言模型到外部系统的 API，提供实时数据和执行数据处理操作。

### 检索增强生成 (Retrieval Augmented Generation - RAG)

RAG 是一种将相关数据整合到提示中以获得准确 AI 模型响应的技术。

该方法涉及一个批处理风格的编程模型，其中 ETL（提取、转换和加载）管道从文档中读取非结构化数据，进行转换（重要步骤包括将文档分割成保留语义边界的小块，并进一步分割成小于模型令牌限制的小块），然后写入向量数据库。

处理用户输入时，用户问题和所有“相似”的文档片段被放入发送给 AI 模型的提示中。向量数据库擅长查找相似内容。

### 工具调用 (Tool Calling)

大型语言模型训练后知识会过时，且无法访问或修改外部数据。

工具调用机制解决了这些缺点，允许注册服务作为工具连接 LLM 到外部系统 API，提供实时数据和执行操作。

Spring AI 简化了工具调用代码，处理工具调用对话。可以将工具作为 `@Tool` 注解的方法提供。

工具调用流程：
1. 在聊天请求中包含工具定义（名称、描述、输入参数 schema）。
2. 模型决定调用工具时，发送包含工具名称和输入参数的响应。
3. 应用负责识别并执行工具。
4. 应用处理工具调用结果。
5. 应用将结果发送回模型。
6. 模型使用结果作为额外上下文生成最终响应。

## 评估 AI 响应 (Evaluating AI responses)

有效评估 AI 系统对用户请求的输出对于确保最终应用的准确性和实用性非常重要。可以使用预训练模型本身进行评估。

评估过程分析生成响应是否符合用户意图和查询上下文，使用相关性、连贯性和事实正确性等指标衡量质量。一种方法是将用户请求和 AI 模型响应都提供给模型进行评估。利用向量数据库中的信息作为补充数据可以增强评估过程。

Spring AI 项目提供了 `Evaluator` API，目前提供评估模型响应的基本策略。
